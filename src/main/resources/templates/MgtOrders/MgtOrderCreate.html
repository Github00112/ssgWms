<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" xmlns:sec="http://www.w3.org/1999/xhtml"
      layout:decorate="~{layout/layout1}">

<head>
    <title>Home2</title>
    <link href="/assets/css/styleMgtOrders.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body id="body-pd">

<div layout:fragment="content">

    <!--main contents Start-->


    <div class="row">
        <div class="col-sm-12" style="padding-right: 0">
            <div class="bg-light rounded h-30">
                <h6 class="mb-4">발주등록</h6>
                <div class="section top-section">
                    <form id="mgtOrderForm" action="/MgtOrders/MgtOrderCreate" method="post">
                        <div class="row">
                            <div>
                                <label for="order-date-start">발주일자 * :</label>
                                <input type="date" id="order-date-start" name="createdAt">
                            </div>
                            <div>
                                <label for="order-id">발주번호 :</label>
                                <input type="number" id="order-id" th:value="${id}" readonly>
                                <input type="hidden" id="orderId" value="${id}">
                            </div>
                            <div>
                                <label for="supplier">발주상태 :</label>
                                <input type="text" id="status" value="READY" name="status" readonly>
                            </div>
                        </div>
                        <div class="row">
                            <div>
                                <label for="supplier">매입거래처 :</label>
                                <input type="text" id="supplier" placeholder="Company" name="purchaser">
                            </div>
                            <div>
                                <label for="warehouse">창고ID :</label>
                                <input type="text" id="warehouse" placeholder="Warehouse 1" name="warehouseId">
                            </div>
                            <div></div>
                        </div>
                        <div class="button-row">
                            <!-- Check if id is present -->
                            <button class="btn btn-primary" type="submit" th:if="${id == null}">Create</button>
                            <!-- Disable the button if id is present -->
                            <button class="btn btn-primary" type="submit" th:if="${id != null}" disabled>Create</button>
                        </div>
                    </form>
                </div>
            </div>
            <div></div>
            <div class="bg-light rounded h-50 p-4">

                <div class="section bottom-section">
                    <form id="addItems" action="/MgtOrders/AddItems" method="post">
                        <div class="input-fields">
                            <label for="item-name">상품번호:</label>
                            <input type="number" id="item-name" placeholder="상품번호 입력">
                            <label for="item-quantity">수량:</label>
                            <input type="number" id="item-quantity" placeholder="수량 입력">
                            <button class="btn btn-primary" type="button" id="addRowBtn">추가</button>
                        </div>
                        <table class="table table-bordered">
                            <thead>
                            <tr>
                                <th scope="col" style="background-color: #acd1ea;">No.</th>
                                <th scope="col" style="background-color: #acd1ea;"><input type="checkbox" checked>
                                </th>
                                <th scope="col" style="background-color: #acd1ea;">Item</th>
                                <th scope="col" style="background-color: #acd1ea;">Quantity</th>
                            </tr>
                            </thead>
                            <!--                        <tbody id="warehouse-data">-->
                            <!--                        </tbody>-->
                            <!--            아이템 테이블 리스트-->
                            <tbody id="table-body">

                            </tbody>
                        </table>
                        <div class="button-row">
                            <div>
                                <button class="btn btn-primary" type="submit" onclick="showAlert()">Save</button>
                            </div>
                            <div>
                                <button class="btn btn-primary" type="button" id="deleteBtn">Delete</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!--main contents End-->


</div>
</body>

<script th:inline="javascript">
    let rowCount = document.querySelectorAll('#table-body tr').length; // 초기 행 개수

    function addRow() {
        const itemName = document.getElementById('item-name').value;
        const itemQuantity = document.getElementById('item-quantity').value;

        if (itemName && itemQuantity) {
            const tableBody = document.getElementById('table-body');
            if (tableBody) {
                const newRow = document.createElement('tr');
                const tdNo = document.createElement('td');
                tdNo.textContent = ++rowCount;
                const tdCheckbox = document.createElement('td');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = 'false';
                tdCheckbox.appendChild(checkbox);
                const tdItem = document.createElement('td');
                const itemInput = document.createElement('input');
                itemInput.type = 'text';
                itemInput.name = 'itemNames';
                itemInput.value = itemName;
                tdItem.appendChild(itemInput);
                const tdQuantity = document.createElement('td');
                const quantityInput = document.createElement('input');
                quantityInput.type = 'number';
                quantityInput.name = 'quantities';
                quantityInput.value = itemQuantity;
                tdQuantity.appendChild(quantityInput);

                newRow.appendChild(tdNo);
                newRow.appendChild(tdCheckbox);
                newRow.appendChild(tdItem);
                newRow.appendChild(tdQuantity);

                tableBody.appendChild(newRow);
            }
            document.getElementById('item-name').value = '';
            document.getElementById('item-quantity').value = '';
        }
    }

    function deleteCheckedItems() {
        // Serialize the form data containing the checked checkboxes
        var formData = $('#addItems').serialize();

        // Send an AJAX request to the server to delete the selected rows
        $.ajax({
            url: '/MgtOrders/DeleteItems', // Update the endpoint accordingly
            type: 'POST',
            data: formData,
            success: function (response) {
                // Log the response from the server
                console.log('Response:', response);

                // Check if the response indicates successful deletion
                if (response === 'Items deleted successfully') {
                    // Iterate over the checked checkboxes and remove their parent rows
                    $('#table-body input[type="checkbox"]:checked').each(function () {
                        $(this).closest('tr').remove();
                    });

                    // Log a message indicating successful deletion
                    console.log('Selected rows deleted successfully');

                    // You can update the UI or perform any other actions here
                } else {
                    // Log an error message if deletion was unsuccessful
                    console.error('Failed to delete selected rows:', response);
                    // You can handle the error or inform the user accordingly
                }
            },
            error: function (xhr, status, error) {
                // Handle any errors
                console.error('Error:', error);
            }
        });
    }

    $('#addItems').submit(function (event) {
        event.preventDefault(); // Prevent the default form submission

        var checkedItems = [];

        $('#table-body tr').each(function (index, row) {
            var checkbox = $(row).find('input[type="checkbox"]');
            if (checkbox.is(':checked')) {
                var values = checkbox.val().split(','); // Split value into itemName and quantity
                var itemName = values[0];
                var quantity = values[1];

                checkedItems.push({itemName: itemName, quantity: quantity});
            }
        });

        var idValue = $('#order-id').val();
        console.log(idValue);
        var requestData = {
            checkedItems: checkedItems,
            id: idValue
        };
        console.log(requestData);

        // var idValue = [[${id}]];

        // Send JSON data to server using Ajax
        $.ajax({
            url: '/MgtOrders/AddItems',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(requestData),
            success: function (response) {
                console.log("response id : " + response.id);
                console.log('Data submitted successfully');
            },
            error: function (xhr, status, error) {
                console.error('Error:', error);
            }
        });
    })
    // 추가 버튼 클릭 이벤트 바인딩
    document.getElementById('addRowBtn').addEventListener('click', addRow);

    document.getElementById('deleteBtn').addEventListener('click', function (event) {
        // Prevent the default click behavior
        event.preventDefault();

        // Call the function to delete checked items
        deleteCheckedItems();
    });

    function showAlert() {
        alert("저장되었습니다!");
    }


    document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('mgtOrderForm').addEventListener('submit', function (event) {
            event.preventDefault(); // Prevent default form submission

            // Get form data
            var formData = {
                createdAt: document.getElementById('order-date-start').value + "T00:00", // YYYY-MM-DD 형식으로 변환
                purchaser: document.getElementById('supplier').value,
                status: document.getElementById('status').value,
                warehouseId: document.getElementById('warehouse').value
            };

            // Convert form data to JSON
            var jsonData = JSON.stringify(formData);

            // Send AJAX request
            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/MgtOrders/MgtOrderCreate');
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.onload = function () {
                if (xhr.status === 200) {
                    // Handle success response
                    var response = JSON.parse(xhr.responseText);
                    console.log(response); // Log response to console
                    // Optionally, update UI or redirect to another page
                    // Check if the response contains the order ID
                    if (response.id) {
                        // Update the UI to display the order ID
                        document.getElementById('order-id').value = response.id;
                    } else {
                        console.error('Order ID not found in the response');
                    }
                } else {
                    // Handle error response
                    console.error('Request failed with status:', xhr.status);
                }
            };
            xhr.send(jsonData);
        });
    });
</script>