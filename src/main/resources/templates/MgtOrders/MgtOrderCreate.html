<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- CSS -->
    <link rel="stylesheet" href="/css/styles.css">

    <title>SideBar sub menus</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body id="body-pd">
<div class="l-navbar" id="navbar">
    <nav class="nav">
        <div>
            <div class="nav__brand">
                <ion-icon name="menu-outline" class="nav__toggle" id="nav-toggle"></ion-icon>
                <a href="#" class="nav__logo"><img src="/TeamLogo.png" style="width: 100px; height: 80px;">
                </a>
            </div>
            <div class="nav__list">
                <a href="#" class="nav__link">
                    <ion-icon name="home-outline" class="nav__icon"></ion-icon>
                    <span class="nav_name">창고관리</span>
                </a>

                <a href="#" class="nav__link">
                    <i class="bi bi-boxes"></i>
                    <span class="nav_name">배송관리</span>
                </a>
                <a href="#" class="nav__link has-submenu" onmouseover="showSubmenu(this)">
                    <i class="bi bi-box-arrow-down"></i>
                    <span class="nav_name">출고관리</span>
                </a>
                <div class="collapse__menu">
                    <a href="#" class="collapse__sublink">출고 신청</a>
                    <a href="#" class="collapse__sublink">배송 준비</a>
                    <a href="#" class="collapse__sublink">배송 완료</a>
                </div>

                <a href="#" class="nav__link has-submenu" onmouseover="showSubmenu(this)">
                    <i class="bi bi-box-arrow-in-down"></i>
                    <span class="nav_name">입고관리</span>
                </a>
                <div class="collapse__menu">
                    <a href="#" class="collapse__sublink">입고 접수</a>
                    <a href="#" class="collapse__sublink">입고 처리</a>
                    <a href="#" class="collapse__sublink">반품 처리</a>
                </div>

                <a href="#" class="nav__link has-submenu" onmouseover="showSubmenu(this)">
                    <i class="bi bi-wallet-fill"></i>
                    <span class="nav_name">정산관리</span>
                </a>
                <div class="collapse__menu">
                    <a href="#" class="collapse__sublink">정산 항목1</a>
                    <a href="#" class="collapse__sublink">정산 항목2</a>
                    <a href="#" class="collapse__sublink">정산 항목3</a>
                </div>

                <a href="#" class="nav__link has-submenu" onmouseover="showSubmenu(this)">
                    <ion-icon name="pie-chart-outline" class="nav__icon"></ion-icon>
                    <span class="nav_name">발주관리</span>
                </a>
                <div class="collapse__menu">
                    <a href="/MgtOrders/MgtOrderCreate" class="collapse__sublink">발주 등록</a>
                    <a href="/MgtOrders/MgtOrderConfirm" class="collapse__sublink">발주 확정</a>
                    <a href="/MgtOrders/MgtOrderSearch" class="collapse__sublink">발주 조회</a>
                    <a href="/MgtOrders/MgtOrderNondeliverd" class="collapse__sublink">발주대비미입고목록</a>
                </div>

                <a href="#" class="nav__link has-submenu" onmouseover="showSubmenu(this)">
                    <ion-icon name="settings-outline" class="nav__icon"></ion-icon>
                    <span class="nav_name">재고관리</span>
                </a>
                <div class="collapse__menu">
                    <a href="#" class="collapse__sublink">재고 항목1</a>
                    <a href="#" class="collapse__sublink">재고 항목2</a>
                    <a href="#" class="collapse__sublink">재고 항목3</a>
                </div>

                <a href="#" class="nav__link has-submenu" onmouseover="showSubmenu(this)">
                    <ion-icon name="log-out-outline" class="nav__icon"></ion-icon>
                    <span class="nav_name">주문관리</span>
                </a>
                <div class="collapse__menu">
                    <a href="#" class="collapse__sublink">주문 항목1</a>
                    <a href="#" class="collapse__sublink">주문 항목2</a>
                    <a href="#" class="collapse__sublink">주문 항목3</a>
                </div>
            </div>

        </div>
    </nav>
</div>

<h1> 발주등록 </h1>
<div class="section top-section">
    <form action="/MgtOrders/MgtOrderCreate" method="post">
        <div class="row">
            <div>
                <label for="order-date-start">발주일자 * :</label>
                <input type="date" id="order-date-start" name="createdAt">
            </div>
            <div>
                <label for="order-id">발주번호 :</label>
                <input type="number" id="order-id" th:value="${id}" readonly>
            </div>
            <div>
                <label for="supplier">발주상태 :</label>
                <input type="text" id="status" value="READY" name="status" readonly>
            </div>
        </div>
        <div class="row">
            <div>
                <label for="supplier">매입거래처 :</label>
                <input type="text" id="supplier" placeholder="Company" name="purchaser">
            </div>
            <div>
                <label for="warehouse">창고ID :</label>
                <input type="text" id="warehouse" placeholder="Warehouse 1" name="warehouseId">
            </div>
            <div></div>
        </div>
        <div class="button-row">
            <!-- Check if id is present -->
            <button type="submit" th:if="${id == null}">Create</button>
            <!-- Disable the button if id is present -->
            <button type="submit" th:if="${id != null}" disabled>Create</button>
        </div>
    </form>
</div>
<div class="section bottom-section">
    <form id="addItems" action="/MgtOrders/AddItems" method="post">
        <div class="input-fields">
            <label for="item-name">상품번호:</label>
            <input type="number" id="item-name" placeholder="상품번호 입력">
            <label for="item-quantity">수량:</label>
            <input type="number" id="item-quantity" placeholder="수량 입력">
            <button type="button" id="addRowBtn">추가</button>
        </div>
        <table>
            <thead>
            <tr>
                <th>No.</th>
                <th><input type="checkbox" checked></th>
                <th>Item</th>
                <th>Quantity</th>
            </tr>
            </thead>
<!--            아이템 테이블 리스트-->
            <tbody id="table-body">

            </tbody>
        </table>
        <div></div>
        <div class="button-row">
            <div>
                <button type="submit" onclick="showAlert()">Save</button>
            </div>
            <div>
                <button type="button" id="deleteBtn">Delete</button>
            </div>
        </div>
    </form>
</div>
<!-- IONICONS -->
<script src="https://unpkg.com/ionicons@5.2.3/dist/ionicons.js"></script>
<!-- JS -->
<script src="/js/main.js"></script>
<script th:inline="javascript">
    let rowCount = document.querySelectorAll('#table-body tr').length; // 초기 행 개수

    // function addRow() {
    //     const itemName = document.getElementById('item-name').value;
    //     const itemQuantity = document.getElementById('item-quantity').value;
    //
    //     if (itemName && itemQuantity) {
    //         const tableBody = document.getElementById('table-body');
    //         if (tableBody) {
    //             const newRow = document.createElement('tr');
    //             const tdNo = document.createElement('td');
    //             tdNo.textContent = ++rowCount;
    //             const tdCheckbox = document.createElement('td');
    //             const checkbox = document.createElement('input');
    //             checkbox.type = 'checkbox';
    //             checkbox.value = 'false';
    //             tdCheckbox.appendChild(checkbox);
    //             const tdItem = document.createElement('td');
    //             const itemInput = document.createElement('input');
    //             itemInput.type = 'text';
    //             itemInput.name = 'itemNames';
    //             itemInput.value = itemName;
    //             tdItem.appendChild(itemInput);
    //             const tdQuantity = document.createElement('td');
    //             const quantityInput = document.createElement('input');
    //             quantityInput.type = 'number';
    //             quantityInput.name = 'quantities';
    //             quantityInput.value = itemQuantity;
    //             tdQuantity.appendChild(quantityInput);
    //
    //             newRow.appendChild(tdNo);
    //             newRow.appendChild(tdCheckbox);
    //             newRow.appendChild(tdItem);
    //             newRow.appendChild(tdQuantity);
    //
    //             tableBody.appendChild(newRow);
    //         }
    //         document.getElementById('item-name').value = '';
    //         document.getElementById('item-quantity').value = '';
    //     }
    // }

    function addRow() {
        const itemName = document.getElementById('item-name').value;
        const itemQuantity = document.getElementById('item-quantity').value;

        if (itemName && itemQuantity) {
            const tableBody = document.getElementById('table-body');
            if (tableBody) {
                const newRow = document.createElement('tr');
                const tdNo = document.createElement('td');
                tdNo.textContent = ++rowCount;

                const tdCheckbox = document.createElement('td');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.name = 'checkedItems'; // Set the name for each checkbox
                checkbox.value = itemName + ',' + itemQuantity; // Set a value to identify the checked item
                tdCheckbox.appendChild(checkbox);

                const tdItem = document.createElement('td');
                tdItem.textContent = itemName;

                const tdQuantity = document.createElement('td');
                tdQuantity.textContent = itemQuantity;

                newRow.appendChild(tdNo);
                newRow.appendChild(tdCheckbox);
                newRow.appendChild(tdItem);
                newRow.appendChild(tdQuantity);

                tableBody.appendChild(newRow);
            }
            document.getElementById('item-name').value = '';
            document.getElementById('item-quantity').value = '';
        }
    }


    function deleteCheckedItems() {
        // Serialize the form data containing the checked checkboxes
        var formData = $('#addItems').serialize();

        // Send an AJAX request to the server to delete the selected rows
        $.ajax({
            url: '/MgtOrders/DeleteItems', // Update the endpoint accordingly
            type: 'POST',
            data: formData,
            success: function(response) {
                // Log the response from the server
                console.log('Response:', response);

                // Check if the response indicates successful deletion
                if (response === 'Items deleted successfully') {
                    // Iterate over the checked checkboxes and remove their parent rows
                    $('#table-body input[type="checkbox"]:checked').each(function() {
                        $(this).closest('tr').remove();
                    });

                    // Log a message indicating successful deletion
                    console.log('Selected rows deleted successfully');

                    // You can update the UI or perform any other actions here
                } else {
                    // Log an error message if deletion was unsuccessful
                    console.error('Failed to delete selected rows:', response);
                    // You can handle the error or inform the user accordingly
                }
            },
            error: function(xhr, status, error) {
                // Handle any errors
                console.error('Error:', error);
            }
        });
    }

    $('#addItems').submit(function(event) {
        event.preventDefault(); // Prevent the default form submission

        var checkedItems = [];

        $('#table-body tr').each(function(index, row) {
            var checkbox = $(row).find('input[type="checkbox"]');
            if (checkbox.is(':checked')) {
                var values = checkbox.val().split(','); // Split value into itemName and quantity
                var itemName = values[0];
                var quantity = values[1];

                checkedItems.push({ itemName: itemName, quantity: quantity });
            }
        });

        var idValue = [[${id}]];

        var requestData = {
            checkedItems: checkedItems,
            id: idValue
        };

        // Send JSON data to server using Ajax
        $.ajax({
            url: '/MgtOrders/AddItems',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(requestData),
            success: function(response) {
                // Handle response from server
                if (response.ok) {
                    console.log('Data submitted successfully');
                } else {
                    console.error('Failed to submit data');
                }
            },
            error: function(xhr, status, error) {
                console.error('Error:', error);
            }
        });
    });

    // $('#addItems').submit(function(event) {
    //     event.preventDefault(); // Prevent the default form submission
    //
    //     // Initialize an array to store the checked item names and quantities
    //     var checkedItems = [];
    //
    //     // Loop through each table row in the tbody
    //     $('#table-body tr').each(function(index, row) {
    //         // Check if the checkbox in the current row is checked
    //         if ($(row).find('input[type="checkbox"]').is(':checked')) {
    //             // If checked, get the item name and quantity from the row
    //             var itemName = $(row).find('.item-name').text();
    //             var quantity = $(row).find('.item-quantity').text();
    //
    //             // Add the checked item to the checkedItems array
    //             checkedItems.push({ itemName: itemName, quantity: quantity });
    //         }
    //     });
    //
    //     // Serialize form data
    //     var formData = $(this).serialize();
    //
    //     // Get the id value from the HTML element
    //     var idValue = [[${id}]];
    //
    //     // Append the id value to the form data
    //     formData += '&id=' + idValue;
    //
    //     // Convert the checkedItems array to JSON and append it to the form data
    //     formData += '&checkedItems=' + JSON.stringify(checkedItems);
    //
    //     // Send form data to server using Ajax
    //     $.ajax({
    //         url: '/MgtOrders/AddItems',
    //         method: 'POST',
    //         data: formData,
    //         success: function(response) {
    //             // Handle response from server
    //             if (response.ok) {
    //                 // Server response was successful
    //                 console.log('Data submitted successfully');
    //                 // Optionally, reset the form
    //                 // $('#yourFormId').trigger('reset');
    //             } else {
    //                 // Server response was not successful
    //                 console.error('Failed to submit data');
    //             }
    //         },
    //         error: function(xhr, status, error) {
    //             // Handle errors
    //             console.error('Error:', error);
    //         }
    //     });
    // });

    //
    // window.onload = function () {
    //     // Get the id value
    //     var idValue = [[${id}]];
    //
    //     // Add an event listener to the form submission
    //     document.getElementById('addItems').addEventListener('submit', function (event) {
    //         // Get the form action URL
    //         var formAction = "/MgtOrders/AddItems";
    //         console.log(idValue);
    //         // Append the id parameter to the form action URL
    //         formAction += "?id=" + idValue;
    //         console.log(formAction);
    //         // Update the form action
    //         this.action = formAction;
    //     });
    //
    //
    //
    // };

    // 추가 버튼 클릭 이벤트 바인딩
    document.getElementById('addRowBtn').addEventListener('click', addRow);

    document.getElementById('deleteBtn').addEventListener('click', function(event) {
        // Prevent the default click behavior
        event.preventDefault();

        // Call the function to delete checked items
        deleteCheckedItems();
    });

    function showAlert() {
        alert("저장되었습니다!");
    }
</script>
</body>
</html>